<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ³ãƒ—ãƒ«Todo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 24px;
      font-weight: 600;
    }

    /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .left-column {
      width: 100%;
    }

    .right-column {
      width: 100%;
    }

    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 2åˆ— */
    @media (min-width: 800px) {
      .main-layout {
        flex-direction: row;
        align-items: flex-start;
      }

      .left-column {
        width: 340px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
      }

      .right-column {
        flex: 1;
        min-width: 0;
      }
    }

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .add-form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .add-form input,
    .add-form textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .add-form input:focus,
    .add-form textarea:focus {
      outline: none;
      border-color: #4a90d9;
    }

    .add-form input {
      margin-bottom: 12px;
    }

    .add-form textarea {
      margin-bottom: 12px;
      resize: vertical;
      min-height: 80px;
    }

    .add-form button {
      width: 100%;
      padding: 14px;
      background: #4a90d9;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .add-form button:hover {
      background: #3a7bc8;
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .filter-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #4a90d9;
    }

    .filter-btn.active {
      background: #4a90d9;
      color: #fff;
      border-color: #4a90d9;
    }

    /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
    .counter {
      text-align: center;
      color: #888;
      font-size: 14px;
      margin-bottom: 16px;
    }

    /* Todoãƒªã‚¹ãƒˆ */
    .todo-list {
      list-style: none;
    }

    .todo-item {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.25s cubic-bezier(0.2, 0, 0, 1),
                  opacity 0.2s,
                  box-shadow 0.2s,
                  margin 0.25s cubic-bezier(0.2, 0, 0, 1);
      cursor: grab;
      user-select: none;
      position: relative;
    }

    .todo-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .todo-item.dragging {
      opacity: 0;
      pointer-events: none;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚´ãƒ¼ã‚¹ãƒˆ */
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      opacity: 0.95;
      transform: rotate(2deg) scale(1.02);
      transition: transform 0.1s ease-out;
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .drop-placeholder {
      background: linear-gradient(135deg, #e8f4fd 0%, #d4e8f8 100%);
      border: 2px dashed #4a90d9;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: height 0.2s cubic-bezier(0.2, 0, 0, 1);
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ä»–ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚·ãƒ•ãƒˆ */
    .todo-item.shift-down {
      transform: translateY(0);
    }

    .todo-item.shift-up {
      transform: translateY(0);
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ãƒ›ãƒãƒ¼åŠ¹æœã‚’ç„¡åŠ¹åŒ– */
    body.is-dragging .todo-item:hover {
      transform: none;
    }

    body.is-dragging {
      cursor: grabbing !important;
      user-select: none;
    }

    .todo-item.completed {
      opacity: 0.6;
    }

    .todo-item.completed .todo-title {
      text-decoration: line-through;
      color: #888;
    }

    .todo-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .drag-handle {
      display: none;
    }

    .todo-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid #4a90d9;
      border-radius: 50%;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .todo-checkbox:hover {
      background: #e8f0fa;
    }

    .todo-item.completed .todo-checkbox {
      background: #4a90d9;
    }

    .todo-checkbox::after {
      content: '';
      width: 10px;
      height: 10px;
      background: #fff;
      border-radius: 50%;
      opacity: 0;
    }

    .todo-item.completed .todo-checkbox::after {
      opacity: 1;
    }

    .todo-content {
      flex: 1;
      min-width: 0;
    }

    .todo-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      word-break: break-word;
    }

    .todo-detail {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* æŠ˜ã‚ŠãŸãŸã¿è©³ç´° */
    .todo-detail.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .detail-toggle {
      background: none;
      border: none;
      color: #4a90d9;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 0;
      margin-top: 4px;
    }

    .detail-toggle:hover {
      text-decoration: underline;
    }

    .todo-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    .todo-date {
      font-size: 12px;
      color: #999;
    }

    .todo-delete {
      padding: 6px 12px;
      border: none;
      background: #ff5252;
      color: #fff;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .todo-delete:hover {
      background: #e04545;
    }

    /* å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .section-title {
      font-size: 14px;
      color: #888;
      margin: 24px 0 12px;
      padding-left: 4px;
    }

    .empty-message {
      text-align: center;
      color: #999;
      padding: 40px 20px;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ãƒ’ãƒ³ãƒˆ */
    .drag-hint {
      text-align: center;
      color: #bbb;
      font-size: 12px;
      margin-bottom: 12px;
    }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ */
    .todo-item.editing {
      cursor: default;
    }

    .todo-item.editing .drag-handle,
    .todo-item.editing .todo-checkbox {
      visibility: hidden;
    }

    .edit-form {
      flex: 1;
    }

    .edit-input,
    .edit-textarea {
      width: 100%;
      padding: 8px 10px;
      border: 2px solid #4a90d9;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .edit-input {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .edit-textarea {
      resize: vertical;
      min-height: 60px;
    }

    .edit-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .edit-save,
    .edit-cancel {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .edit-save {
      background: #4a90d9;
      color: #fff;
    }

    .edit-save:hover {
      background: #3a7bc8;
    }

    .edit-cancel {
      background: #e0e0e0;
      color: #333;
    }

    .edit-cancel:hover {
      background: #d0d0d0;
    }

    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .todo-actions {
      display: flex;
      gap: 8px;
    }

    .todo-edit {
      padding: 6px 12px;
      border: none;
      background: #888;
      color: #fff;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .todo-edit:hover {
      background: #666;
    }

    /* å„ªå…ˆåº¦ã‚¿ã‚° */
    .priority-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      vertical-align: middle;
    }

    .priority-high {
      background: #ffebee;
      color: #c62828;
    }

    .priority-medium {
      background: #fff3e0;
      color: #ef6c00;
    }

    .priority-low {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* å„ªå…ˆåº¦é¸æŠ */
    .priority-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 12px;
      cursor: pointer;
      background: #fff;
      transition: border-color 0.2s;
    }

    .priority-select:focus {
      outline: none;
      border-color: #4a90d9;
    }

    /* ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    .sort-options {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
    }

    .sort-options label {
      white-space: nowrap;
    }

    .sort-select {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      background: #fff;
    }

    .sort-select:focus {
      outline: none;
      border-color: #4a90d9;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>ğŸ“ ä»Šæ—¥ã®Todo</h1>

    <div class="main-layout">
      <!-- å·¦åˆ—: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="left-column">
        <form class="add-form" id="addForm">
          <input type="text" id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..." required>
          <textarea id="detailInput" placeholder="è©³ç´°ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰..."></textarea>
          <select id="priorityInput" class="priority-select">
            <option value="none">å„ªå…ˆåº¦: ãªã—</option>
            <option value="high">å„ªå…ˆåº¦: é«˜</option>
            <option value="medium">å„ªå…ˆåº¦: ä¸­</option>
            <option value="low">å„ªå…ˆåº¦: ä½</option>
          </select>
          <button type="submit">è¿½åŠ ã™ã‚‹</button>
        </form>
      </div>

      <!-- å³åˆ—: Todoãƒªã‚¹ãƒˆ -->
      <div class="right-column">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filters">
          <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
          <button class="filter-btn" data-filter="active">æœªå®Œäº†</button>
          <button class="filter-btn" data-filter="completed">å®Œäº†</button>
        </div>

        <!-- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ -->
        <div class="counter" id="counter"></div>

        <!-- ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div class="sort-options">
          <label>ä¸¦ã³æ›¿ãˆ:</label>
          <select id="sortSelect" class="sort-select">
            <option value="manual">æ‰‹å‹•ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰</option>
            <option value="priority">å„ªå…ˆåº¦é †</option>
            <option value="created">ä½œæˆæ—¥é †</option>
          </select>
        </div>

        <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒ’ãƒ³ãƒˆ -->
        <div class="drag-hint" id="dragHint">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™</div>

        <!-- Todoãƒªã‚¹ãƒˆ -->
        <ul class="todo-list" id="todoList"></ul>
      </div>
    </div>
  </div>

  <script>
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
    const STORAGE_KEY = 'simple-todo-list';

    // çŠ¶æ…‹ç®¡ç†
    let todos = [];
    let currentFilter = 'all';
    let currentSort = 'manual';
    let draggedId = null;
    let editingId = null;
    let expandedIds = new Set(); // è©³ç´°ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹Todoã®ID

    // å„ªå…ˆåº¦ã®é †åºï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰
    const priorityOrder = { high: 0, medium: 1, low: 2, none: 3 };
    const priorityLabels = { high: 'é«˜', medium: 'ä¸­', low: 'ä½', none: '' };

    // DOMè¦ç´ 
    const addForm = document.getElementById('addForm');
    const titleInput = document.getElementById('titleInput');
    const detailInput = document.getElementById('detailInput');
    const priorityInput = document.getElementById('priorityInput');
    const todoList = document.getElementById('todoList');
    const counter = document.getElementById('counter');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const sortSelect = document.getElementById('sortSelect');
    const dragHint = document.getElementById('dragHint');

    // åˆæœŸåŒ–
    function init() {
      loadTodos();
      render();
      setupEventListeners();
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
    function loadTodos() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        todos = JSON.parse(stored);
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    function saveTodos() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        addTodo();
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentFilter = btn.dataset.filter;
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          render();
        });
      });

      // ä¸¦ã³æ›¿ãˆé¸æŠ
      sortSelect.addEventListener('change', () => {
        currentSort = sortSelect.value;
        // æ‰‹å‹•ä»¥å¤–ã¯ãƒ‰ãƒ©ãƒƒã‚°ãƒ’ãƒ³ãƒˆã‚’éè¡¨ç¤º
        dragHint.style.display = currentSort === 'manual' ? 'block' : 'none';
        render();
      });
    }

    // Todoè¿½åŠ 
    function addTodo() {
      const title = titleInput.value.trim();
      const detail = detailInput.value.trim();
      const priority = priorityInput.value;

      if (!title) return;

      const todo = {
        id: Date.now(),
        title,
        detail,
        priority,
        completed: false,
        createdAt: new Date().toISOString()
      };

      todos.unshift(todo);
      saveTodos();
      render();

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      titleInput.value = '';
      detailInput.value = '';
      priorityInput.value = 'none';
      titleInput.focus();
    }

    // Todoå®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆ
    function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.completed = !todo.completed;
        saveTodos();
        render();
      }
    }

    // Todoå‰Šé™¤
    function deleteTodo(id) {
      todos = todos.filter(t => t.id !== id);
      saveTodos();
      render();
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    function startEdit(id) {
      editingId = id;
      render();
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
      const input = document.querySelector('.edit-input');
      if (input) {
        input.focus();
        input.select();
      }
    }

    // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit() {
      editingId = null;
      render();
    }

    // ç·¨é›†ã‚’ä¿å­˜
    function saveEdit(id) {
      const titleInput = document.querySelector('.edit-input');
      const detailInput = document.querySelector('.edit-textarea');
      const prioritySelect = document.querySelector('.edit-priority');

      if (!titleInput) return;

      const newTitle = titleInput.value.trim();
      const newDetail = detailInput ? detailInput.value.trim() : '';
      const newPriority = prioritySelect ? prioritySelect.value : 'none';

      if (!newTitle) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        titleInput.focus();
        return;
      }

      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.title = newTitle;
        todo.detail = newDetail;
        todo.priority = newPriority;
        saveTodos();
      }

      editingId = null;
      render();
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(isoString) {
      const date = new Date(isoString);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${month}/${day} ${hours}:${minutes}`;
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function getFilteredTodos() {
      let filtered = [...todos];

      if (currentFilter === 'active') {
        filtered = filtered.filter(t => !t.completed);
      } else if (currentFilter === 'completed') {
        filtered = filtered.filter(t => t.completed);
      }

      // æœªå®Œäº†ã‚’ä¸Šã€å®Œäº†ã‚’ä¸‹ã«ä¸¦ã¹ã‚‹
      let active = filtered.filter(t => !t.completed);
      let completed = filtered.filter(t => t.completed);

      // ã‚½ãƒ¼ãƒˆé©ç”¨
      if (currentSort === 'priority') {
        const sortByPriority = (a, b) => {
          const pa = priorityOrder[a.priority || 'none'];
          const pb = priorityOrder[b.priority || 'none'];
          return pa - pb;
        };
        active = active.sort(sortByPriority);
        completed = completed.sort(sortByPriority);
      } else if (currentSort === 'created') {
        const sortByCreated = (a, b) => new Date(b.createdAt) - new Date(a.createdAt);
        active = active.sort(sortByCreated);
        completed = completed.sort(sortByCreated);
      }
      // manual ã®å ´åˆã¯ãã®ã¾ã¾ï¼ˆãƒ‰ãƒ©ãƒƒã‚°é †ï¼‰

      return { active, completed, all: [...active, ...completed] };
    }

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ï¼ˆãƒŒãƒ«ãƒŒãƒ«ç‰ˆï¼‰
    let dragState = {
      isDragging: false,
      draggedElement: null,
      ghost: null,
      placeholder: null,
      startY: 0,
      offsetY: 0,
      currentDropIndex: -1
    };

    function setupDragAndDrop() {
      // æ‰‹å‹•ã‚½ãƒ¼ãƒˆä»¥å¤–ã¯ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹
      if (currentSort !== 'manual') return;

      const items = todoList.querySelectorAll('.todo-item:not(.editing)');

      items.forEach(item => {
        // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        item.addEventListener('mousedown', (e) => {
          // ãƒœã‚¿ãƒ³ã‚„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
          if (e.target.closest('button, .todo-checkbox, .detail-toggle, input, textarea, select')) {
            return;
          }
          startDrag(e, item);
        });
        item.addEventListener('touchstart', (e) => {
          if (e.target.closest('button, .todo-checkbox, .detail-toggle, input, textarea, select')) {
            return;
          }
          startDrag(e, item);
        }, { passive: false });
      });
    }

    function startDrag(e, item) {
      if (editingId !== null) return;
      e.preventDefault();

      const touch = e.touches ? e.touches[0] : e;
      const rect = item.getBoundingClientRect();

      dragState.isDragging = true;
      dragState.draggedElement = item;
      dragState.startY = touch.clientY;
      dragState.offsetY = touch.clientY - rect.top;
      draggedId = parseInt(item.dataset.id);

      // ã‚´ãƒ¼ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
      createGhost(item, touch.clientX, touch.clientY);

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
      createPlaceholder(rect.height);

      // å…ƒã®è¦ç´ ã‚’éè¡¨ç¤ºã«
      item.classList.add('dragging');
      document.body.classList.add('is-dragging');

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.addEventListener('mousemove', onDragMove);
      document.addEventListener('mouseup', onDragEnd);
      document.addEventListener('touchmove', onDragMove, { passive: false });
      document.addEventListener('touchend', onDragEnd);
    }

    function createGhost(item, x, y) {
      const ghost = item.cloneNode(true);
      ghost.classList.add('drag-ghost');
      ghost.classList.remove('dragging');
      ghost.style.width = item.offsetWidth + 'px';
      ghost.style.left = (x - item.offsetWidth / 2) + 'px';
      ghost.style.top = (y - dragState.offsetY) + 'px';
      document.body.appendChild(ghost);
      dragState.ghost = ghost;
    }

    function createPlaceholder(height) {
      const placeholder = document.createElement('li');
      placeholder.className = 'drop-placeholder';
      placeholder.style.height = height + 'px';
      dragState.placeholder = placeholder;

      // å…ƒã®ä½ç½®ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æŒ¿å…¥
      dragState.draggedElement.parentNode.insertBefore(placeholder, dragState.draggedElement);
    }

    function onDragMove(e) {
      if (!dragState.isDragging) return;
      e.preventDefault();

      const touch = e.touches ? e.touches[0] : e;

      // ã‚´ãƒ¼ã‚¹ãƒˆã‚’ãƒã‚¦ã‚¹ã«è¿½å¾“
      if (dragState.ghost) {
        dragState.ghost.style.left = (touch.clientX - dragState.draggedElement.offsetWidth / 2) + 'px';
        dragState.ghost.style.top = (touch.clientY - dragState.offsetY) + 'px';
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’è¨ˆç®—
      updateDropPosition(touch.clientY);
    }

    function updateDropPosition(clientY) {
      const items = Array.from(todoList.querySelectorAll('.todo-item:not(.dragging)'));
      const placeholder = dragState.placeholder;

      if (!placeholder) return;

      let insertBeforeElement = null;
      let newIndex = items.length;

      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const rect = item.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;

        if (clientY < midY) {
          insertBeforeElement = item;
          newIndex = i;
          break;
        }
      }

      // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿ï¼‰
      if (newIndex !== dragState.currentDropIndex) {
        dragState.currentDropIndex = newIndex;

        if (insertBeforeElement) {
          // .section-title ã‚’ã‚¹ã‚­ãƒƒãƒ—
          if (insertBeforeElement.classList.contains('section-title')) {
            const nextSibling = insertBeforeElement.nextElementSibling;
            if (nextSibling && nextSibling.classList.contains('todo-item')) {
              insertBeforeElement = nextSibling;
            }
          }
          todoList.insertBefore(placeholder, insertBeforeElement);
        } else {
          todoList.appendChild(placeholder);
        }
      }
    }

    function onDragEnd(e) {
      if (!dragState.isDragging) return;

      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup', onDragEnd);
      document.removeEventListener('touchmove', onDragMove);
      document.removeEventListener('touchend', onDragEnd);

      // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’ç¢ºå®š
      const placeholder = dragState.placeholder;
      const draggedElement = dragState.draggedElement;

      if (placeholder && draggedElement) {
        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ä½ç½®ã«ç§»å‹•
        const items = Array.from(todoList.querySelectorAll('.todo-item:not(.dragging)'));
        const placeholderIndex = Array.from(todoList.children).indexOf(placeholder);

        // æ–°ã—ã„é †åºã§todosã‚’æ›´æ–°
        const allTodoItems = Array.from(todoList.querySelectorAll('.todo-item'));
        const newOrder = [];

        allTodoItems.forEach((item, index) => {
          if (item === draggedElement) return;
          const id = parseInt(item.dataset.id);
          const todo = todos.find(t => t.id === id);
          if (todo) newOrder.push(todo);
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’æ­£ã—ã„ä½ç½®ã«æŒ¿å…¥
        const draggedTodo = todos.find(t => t.id === draggedId);
        if (draggedTodo) {
          // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ä½ç½®ã‚’è¨ˆç®—
          let insertIndex = 0;
          const children = Array.from(todoList.children);
          for (let i = 0; i < children.length; i++) {
            if (children[i] === placeholder) {
              break;
            }
            if (children[i].classList.contains('todo-item') && children[i] !== draggedElement) {
              insertIndex++;
            }
          }

          newOrder.splice(insertIndex, 0, draggedTodo);

          // å®Œäº†/æœªå®Œäº†ã®ç›¸å¯¾é †åºã‚’ç¶­æŒã—ãªãŒã‚‰ã€todosé…åˆ—ã‚’æ›´æ–°
          const activeItems = newOrder.filter(t => !t.completed);
          const completedItems = newOrder.filter(t => t.completed);
          todos = [...activeItems, ...completedItems];

          saveTodos();
        }
      }

      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      cleanupDrag();

      // å†æç”»
      render();
    }

    function cleanupDrag() {
      if (dragState.ghost) {
        dragState.ghost.remove();
      }
      if (dragState.placeholder) {
        dragState.placeholder.remove();
      }
      if (dragState.draggedElement) {
        dragState.draggedElement.classList.remove('dragging');
      }

      document.body.classList.remove('is-dragging');

      dragState = {
        isDragging: false,
        draggedElement: null,
        ghost: null,
        placeholder: null,
        startY: 0,
        offsetY: 0,
        currentDropIndex: -1
      };
      draggedId = null;
    }

    // æç”»
    function render() {
      const { active, completed, all } = getFilteredTodos();

      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
      const activeCount = todos.filter(t => !t.completed).length;
      const completedCount = todos.filter(t => t.completed).length;
      counter.textContent = `æœªå®Œäº†: ${activeCount} / å®Œäº†: ${completedCount}`;

      // ãƒªã‚¹ãƒˆæç”»
      if (all.length === 0) {
        todoList.innerHTML = '<li class="empty-message">TodoãŒã‚ã‚Šã¾ã›ã‚“</li>';
        return;
      }

      let html = '';

      // æœªå®Œäº†ãƒªã‚¹ãƒˆ
      if (active.length > 0) {
        active.forEach(todo => {
          html += createTodoHTML(todo);
        });
      }

      // å®Œäº†ãƒªã‚¹ãƒˆï¼ˆåŒºåˆ‡ã‚Šä»˜ãï¼‰
      if (completed.length > 0 && currentFilter !== 'completed') {
        if (active.length > 0) {
          html += '<li class="section-title">âœ“ å®Œäº†ã—ãŸTodo</li>';
        }
      }

      completed.forEach(todo => {
        html += createTodoHTML(todo);
      });

      todoList.innerHTML = html;

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      todoList.querySelectorAll('.todo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', () => {
          toggleTodo(parseInt(checkbox.dataset.id));
        });
      });

      todoList.querySelectorAll('.todo-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          if (confirm('ã“ã®Todoã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            deleteTodo(parseInt(btn.dataset.id));
          }
        });
      });

      // ç·¨é›†ãƒœã‚¿ãƒ³
      todoList.querySelectorAll('.todo-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          startEdit(parseInt(btn.dataset.id));
        });
      });

      // ç·¨é›†ä¿å­˜ãƒœã‚¿ãƒ³
      todoList.querySelectorAll('.edit-save').forEach(btn => {
        btn.addEventListener('click', () => {
          saveEdit(parseInt(btn.dataset.id));
        });
      });

      // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      todoList.querySelectorAll('.edit-cancel').forEach(btn => {
        btn.addEventListener('click', () => {
          cancelEdit();
        });
      });

      // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã§Enterã‚­ãƒ¼ã§ä¿å­˜
      const editInput = todoList.querySelector('.edit-input');
      if (editInput) {
        editInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit(editingId);
          } else if (e.key === 'Escape') {
            cancelEdit();
          }
        });
      }

      const editTextarea = todoList.querySelector('.edit-textarea');
      if (editTextarea) {
        editTextarea.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            cancelEdit();
          }
        });
      }

      // è©³ç´°ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
      todoList.querySelectorAll('.detail-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.dataset.id);
          if (expandedIds.has(id)) {
            expandedIds.delete(id);
          } else {
            expandedIds.add(id);
          }
          render();
        });
      });

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
      setupDragAndDrop();
    }

    // Todoã®HTMLç”Ÿæˆ
    function createTodoHTML(todo) {
      const isEditing = editingId === todo.id;
      const completedClass = todo.completed ? 'completed' : '';
      const editingClass = isEditing ? 'editing' : '';
      const priority = todo.priority || 'none';

      if (isEditing) {
        return `
          <li class="todo-item ${editingClass}" data-id="${todo.id}">
            <div class="todo-header">
              <div class="todo-checkbox" data-id="${todo.id}"></div>
              <div class="edit-form">
                <input type="text" class="edit-input" value="${escapeHTML(todo.title)}" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                <textarea class="edit-textarea" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰">${escapeHTML(todo.detail || '')}</textarea>
                <select class="edit-priority priority-select">
                  <option value="none" ${priority === 'none' ? 'selected' : ''}>å„ªå…ˆåº¦: ãªã—</option>
                  <option value="high" ${priority === 'high' ? 'selected' : ''}>å„ªå…ˆåº¦: é«˜</option>
                  <option value="medium" ${priority === 'medium' ? 'selected' : ''}>å„ªå…ˆåº¦: ä¸­</option>
                  <option value="low" ${priority === 'low' ? 'selected' : ''}>å„ªå…ˆåº¦: ä½</option>
                </select>
                <div class="edit-buttons">
                  <button class="edit-save" data-id="${todo.id}">ä¿å­˜</button>
                  <button class="edit-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
              </div>
            </div>
          </li>
        `;
      }

      const isExpanded = expandedIds.has(todo.id);
      const needsCollapse = todo.detail && todo.detail.includes('\n');
      const collapsedClass = (needsCollapse && !isExpanded) ? 'collapsed' : '';

      let detailHTML = '';
      if (todo.detail) {
        detailHTML = `<div class="todo-detail ${collapsedClass}">${escapeHTML(todo.detail)}</div>`;
        if (needsCollapse) {
          detailHTML += `<button class="detail-toggle" data-id="${todo.id}">${isExpanded ? 'â–² æŠ˜ã‚ŠãŸãŸã‚€' : 'â–¼ ã‚‚ã£ã¨è¦‹ã‚‹'}</button>`;
        }
      }

      const priorityTagHTML = priority !== 'none'
        ? `<span class="priority-tag priority-${priority}">${priorityLabels[priority]}</span>`
        : '';

      return `
        <li class="todo-item ${completedClass}" data-id="${todo.id}">
          <div class="todo-header">
            <div class="todo-checkbox" data-id="${todo.id}"></div>
            <div class="todo-content">
              <div class="todo-title">${escapeHTML(todo.title)}${priorityTagHTML}</div>
              ${detailHTML}
            </div>
          </div>
          <div class="todo-meta">
            <span class="todo-date">${formatDate(todo.createdAt)}</span>
            <div class="todo-actions">
              <button class="todo-edit" data-id="${todo.id}">ç·¨é›†</button>
              <button class="todo-delete" data-id="${todo.id}">å‰Šé™¤</button>
            </div>
          </div>
        </li>
      `;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ã‚¢ãƒ—ãƒªé–‹å§‹
    init();
  </script>
</body>
</html>
